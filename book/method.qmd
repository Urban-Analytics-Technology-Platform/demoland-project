# Methodology

_add workflow (comprehensive of all the steps)_

## Building Indicators

The original list of indicators (see Intro) was pruned after an initial review of the available data, software, interests of the stakeholders.<br/>We resolved to 4 indicators of interest:

- Air quality
- Green space accessibility
- House prices
- Jobs accessibility

For each of these indicators, we have detailed below how they are generated. This step represents the _basic scenario_.

We have two different types of indicators: while air quality and house prices are "actual data" measurements, accessibility is estimated and generated in a deterministic way, so it can't be directly modelled/predicted using some explanatory variables.

### Accessibility calculation

For accessibility computation, we consider the potential accessibility (cumulative) to green spaces and jobs, that represent the opportunities. We consider a set of (punctual) origins and opportunities' destinations and the time it takes to move between them on the road network, given different transport modes.<br/>
In order to calculate the time it takes from each origin to reach each destination, we need to have a Time Travel Matrix (TTM) between origins and destinations for different means of transport.<br/>To build this, we can generate a graph/network starting from two data sources: data for the road network and data for public transportation schedules.</br>
Once a TTM is built between one set of origins and one set of destinations for a given mode of transport, we can run accessibility analysis on it.

---

**Origins -** For the scope of the project, we consider as origins the coordinates of the Population Weighted Centroids (PWC) of [Output Areas](https://www.ons.gov.uk/census/2001censusandearlier/dataandproducts/outputgeography/outputareas) (OA).



**Destinations -** Per each destination we need to provide the coordinates and a datum for the _opportunity_ (or 'supply', in our case this is the land use), for example the number of jobs available (other opportutnities could be number of schools, health centres, other types of countable features).

For jobs count we consider as destinations the PWC of the working population per Workplace Zones (WPZ) from the 2011 Census ([data available](https://www.nomisweb.co.uk/sources/census_2011_wp) and [definition](https://www.ons.gov.uk/methodology/geography/geographicalproducts/areaclassifications/2011workplacebasedareaclassification/classificationofworkplacezonesfortheukabouttheareaclassifications)). <br/>As an opportunity measure (the job counts) we make the approximation that _the number of workers equals the number of jobs available_. This is an approximation we take in order to preserve the spatial location of the jobs, that is relevant in the calculation of the time travel matrix. In fact the number of jobs in the Census is at OAs level, but the PWC for this aggregated level can be off-centered in relation to where people work.

For green spaces accessibility we use the open data set available from [Ordnance Survey](https://beta.ordnancesurvey.co.uk/products/os-open-greenspace) (OS). <br/>In particular as a first approximation we consider the layer "Access points" from this datum. This gives the coordinates of the access points to green spaces in all Great Britain, which we take as destinations.<br/>As an opportunity measure we count the areas of the greenspace (layer "Sites") to which these points give access to, see below for details on how we consider the cumulative opportunity of this datum.

---

**1. Indicator definition**

a. Jobs accessibility

> Number of jobs accessible by public transport and walking in 15 minutes


b. Green spaces accessibility

> Sum of the areas of green space sites reachable within 15 minutes

1. obtain greenspace sites from OS
    - filter out not relevant categories (allottments, golf courses, bowling greens)
    - retain entrances on the edge of the sites
    - associate
2. ~~ obtain "missing" areas from Corine or OSM~~ _idea for future improvement_
3. get sites' area
4. filter entrances within time threshold (15min) per each origin (OA)
5. consider unique values for parks (can be reached in )
5. generate metric per each OA as _Sum [reachable site size]_


**2. Build time travel matrix (TTM)**

We can build a TTM from two data sources: the roads network and a time table for public transport. We can obtain the first by donwloading [OpenStreetMap (OSM)](https://wiki.openstreetmap.org/wiki/Downloading_data) data for the area of interest.<br/>
Time table for public transport in GTFS format is available in England from [UK2GTFS](https://itsleeds.github.io/UK2GTFS/).<br/>
We use GTFS data because more of compatibility with the ttm calculation package.

- get time table for public transport > GTFS data
- get roads network > OSM data
- generate network graph > `r5` engine ([Conveyal(https://github.com/conveyal/r5)]) > `r5py` [package](https://r5py.readthedocs.io/)
- generate ttm for 4 different modes > 'transit', 'bike', 'car', 'walking'
- time is fixed atm > _idea for future improvement_: edit for taking into account different day of the year/week, time of the day


**3. Run accessibility analysis**

- get land use data (opportunities detailed above in _*Destinations_)
- _jobs_ > run `tracc` [package](https://github.com/jamaps/tracc) on the ttm _per each transport mode_:
    - compute impedance function based on a 15 minute cost (cumulative)
    - setting up the accessibility object IE joining the destination data to the travel time data
    - measuring potential accessibility to jobs as cumulative sum of opportunities at destination per each origin
- _greenspace_ > convert the `tracc` functions to work only on reachable sites' area, on the ttm _per each transport mode_:
    - compute impedance function based on a 15 minute cost (cumulative)
    - join the destination data to the travel time data
    - per each OA (origin), filtering only entrances with time travel within the threshold
    - per each OA, filter entrances (only one per park)
    - per each OA, assign metric as sum[parks' area]


### Air quality index

We develop an air quality index as a composite of $PM_{2.5}$, $PM_{10}$, $NO_{2}$ and
$SO_{2}$ particle values derived from the UK AIR project run by DEFRA with data
available as a 1km grid (https://uk-air.defra.gov.uk/data/pcm-data). The composite index
follows the methodology of European Environmental Agency, reflecting the relative health
risk associated to the exposure to particle intensities.

> The bands are based on the relative risks associated to short-term exposure to PM2.5, O3 and NO2, as defined by the World Health Organization in its report on the Health Risks of Air Pollution in Europe project (HRAPIE project report).
>
> The relative risk of exposure to PM2.5 is taken as basis for driving the index, specifically the increase in the risk of mortality per 10 µg/m3 increase in the daily mean concentration of PM2.5.
>
> Assuming linearity across the relative risks functions for O3 and NO2, we calculate the concentrations of these pollutants that pose an equivalent relative risk to a 10 µg/m3 increase in the daily mean of PM2.5.
>
> For PM10 concentrations, a constant ratio between PM10 and PM2.5 of 1:2 is assumed, in line with the World Health Organization´s air quality guidelines for Europe.
>
> For SO2, the bands reflect the limit values set under the EU Air Quality Directive.

The relationship between $PM_{2.5}$ : $PM_{10}$ : $NO_{2}$ : $O_{3}$ : $SO_{2}$ is then
equal to 1 : 2 : 4 : 5 : 10. The combined index can then be computed as
$$Q_{air} = \frac{PM_{2.5}}{1} + \frac{PM_{10}}{2} + \frac{NO_{2}}{4} + \frac{O_{3}}{5} + \frac{SO_{2}}{10}$$

Except for the $O_{3}$, UK AIR reports all as a concentration in
$\mu g \cdot m^{-3}$. $O_{3}$ is reported as a number of days above a threshold of
120 $\mu g \cdot m^{-3}$ and cannot be used in this formula but even EEA omits data when
unavailable so we shall be able to create the index based on 4 remaning measurements.

It shall also be considered that UK AIR is not representing a direct measurements but a model.

The data from the 1km grid are spatially interpolated to Output Area geometry. The index
itself is computed on the grid.

### House price

An optimal way of working with house prices in the modelling exercise like ours is to
use price per sqm. However, those are not generally available at the level of Output
Area or similar. Luckily, we can retrieve such data from the "_A new attribute-linked
residential property price dataset for England and Wales 2011-2019_" project by Chi et
al. available from [10.5255/UKDA-SN-854240](https://dx.doi.org/10.5255/UKDA-SN-854240). That contains individual
house prices, total floor area and a resulting price per sqm resulting from a
combination of Land Registry Price Paid Data and Domestic Energy Performance Certificates.

We use the data from years 2018-2019 and compute the mean price per sqm per output area.
Given the data is not fully up-to-date, the modelling results will be presented as a
percentual increase or decrease compared to the baseline value rather than in absolute
values.

## Explanatory variables

We use a set of explanatory variables describing the environment that can be changed
to model different scenarios and have, at the same time, explanatory power to predict our
four indicators.

### ONS population estimates

We use the ONS population estimates on the OA level for mid-2020. The other data used in the project
are generally reflecting the period 2018-2020, so we want to ensure we describe the compatible point
in time. The dataset is retrieved from the [ONS](https://www.ons.gov.uk/file?uri=/peoplepopulationandcommunity/populationandmigration/populationestimates/datasets/censusoutputareaestimatesinthenortheastregionofengland/mid2020sape23dt10d/sape23dt10dmid2020coaunformattedsyoaestimatesnortheast.xlsx). Given it is reported on Output Area level,
it can be simply joined.

### Workplace population by industry

Workplace population is coming from the Census 2011 and is reported on Workplace Zone geometries.
We use the data preprocessed in the Urban Grammar project that aggregated industries into
following groups:

- A, B, D, E. Agriculture, energy and water
- C. Manufacturing
- F. Construction
- G, I. Distribution, hotels and restaurants
- H, J. Transport and communication
- K, L, M, N. Financial, real estate, professional and administrative activities
- O,P,Q. Public administration, education and health
- R, S, T, U. Other

The data is then interpolated from Workplace Zones to Output Areas.

### CORINE Land Cover classification

We use CORINE Land Cover Classification for 2018 distributed as polygons of contiguous areas
belonging to the same classs. We use the data extracted for the Great Britain within the
Urban Grammar project and interpolate the data onto Output Areas capturing a proportion of
each OA covered by each class. We further filter out fully or nearly invariant classes and use only:

- Discontinuous urban fabric
- Continuous urban fabric
- Non-irrigated arable land
- Industrial or commercial units
- Green urban areas
- Pastures
- Sport and leisure facilities

### Urban morphometrics

Urban morphometrics offers a way of describing physical built environment (buildings, streets)
in a set of measurements capturing different aspects of morphological elements. We directly
use the set measured within the Urban Grammar project, presented as _individual_ characters
(prior contextualisation) and interpolate their values from the original geometry (enclosed
tessellation cells) to output areas. That way, we already get a contextual version using the
project-specific aggregation to OA. This gives us 59 morphometric variables.

### Variable pruning

Given some of the explanatory variable were collected for a different purpose than modelling
and with a different geographical extent in mind, it may happen that within our limited area of
interest (Tyne and Wear), some of the variable are collinear. Those may negatively affect the
performance of the predictive models and it is better to limit their number to minimum. We, therefore,
measure Pearson's correlation index and Spearman Rank correlation index between all pairs of
explanatory variables and from each pair with the absolute value of the index above 0.8
retain only one, ideally the one that is more interpretable.

The final set contains 59 explanatory variables and the only morphometric were pruned down.

- population estimate
- A, B, D, E. Agriculture, energy and water
- C. Manufacturing
- F. Construction
- G, I. Distribution, hotels and restaurants
- H, J. Transport and communication
- K, L, M, N. Financial, real estate, professional and administrative activities
- O,P,Q. Public administration, education and health
- R, S, T, U. Other
- Land cover [Discontinuous urban fabric]
- Land cover [Continuous urban fabric]
- Land cover [Non-irrigated arable land]
- Land cover [Industrial or commercial units]
- Land cover [Green urban areas]
- Land cover [Pastures]
- Land cover [Sport and leisure facilities]
- area of building
- courtyard area of building
- circular compactness of building
- corners of building
- squareness of building
- equivalent rectangular index of building
- centroid - corner mean distance of building
- centroid - corner distance deviation of building
- orientation of building
- area of ETC
- circular compactness of ETC
- equivalent rectangular index of ETC
- covered area ratio of ETC
- cell alignment of building
- alignment of neighbouring buildings
- mean distance between neighbouring buildings
- perimeter-weighted neighbours of ETC
- mean inter-building distance
- width of street profile
- width deviation of street profile
- openness of street profile
- length of street segment
- linearity of street segment
- mean segment length within 3 steps
- node degree of junction
- local proportion of 3-way intersections of street network
- local proportion of 4-way intersections of street network
- local proportion of cul-de-sacs of street network
- local closeness of street network
- local cul-de-sac length of street network
- square clustering of street network
- local degree weighted node density of street network
- street alignment of building
- area covered by edge-attached ETCs
- buildings per meter of street segment
- reached ETCs by neighbouring segments
- reached ETCs by tessellation contiguity
- area of enclosure
- circular compactness of enclosure
- equivalent rectangular index of enclosure
- orientation of enclosure
- perimeter-weighted neighbours of enclosure
- area-weighted ETCs of enclosure

### Modelling / regression analysis


## Building scenarios

TBC